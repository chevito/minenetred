

@model Minenetred.web.ViewModels.ProjectsViewModel

@{
    ViewData["Title"] = "ProjectsList";
}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script>
    $(document).ready(function () {
        var baseAdress = document.location.origin;
        $('#date').change(function () {
            if ($('.datesTable').css('display') == 'none') {
                $('.datesTable').toggle("slide");
            }
            var valueDate = new Date($('#date').val());
            valueDate.setDate(valueDate.getDate() + 1);
            valueDate.getFullYear() + '-' +
                ('0' + (valueDate.getMonth() + 1)).slice(-2) + '-' +
                ('0' + valueDate.getDate()).slice(-2);
            var weekDays = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
            $('.tableHeader').each(function (i, obj) {

                var displayDate = valueDate.getFullYear() + '-' +
                    ('0' + (valueDate.getMonth() + 1)).slice(-2) + '-' +
                    ('0' + valueDate.getDate()).slice(-2);
                var weekDay = weekDays[valueDate.getDay()]
                $(this).html('<h3>' + weekDay + '</h3>' + '<text>' + displayDate + '</text>');
                valueDate.setDate(valueDate.getDate() + 1);
            });
            $('.table-row').each(function () {
                $(this).children('.time-entries').each(function (indexColumn) {
                    var date = $(this).closest('table').find('th').eq($(this).index()).find('text').text();
                    var projectId = $(this).parent("tr").find("td:first").find('input').val();
                    $.ajax({
                        url: baseAdress + '/Entries/' + projectId + '/' + date,
                        dataType: 'json',
                        success: function (result) {
                            var sum = 0;
                            $.each(result.timeEntries, function (index, value) {
                                sum = sum + value.hours;
                            });
                            var actualIndex = indexColumn + 1;
                            $('#' + projectId).children('td:eq(' + actualIndex + ')').find('text').html('Hours logged:<br/> <h4>' + sum + '</h4> ');

                            $('.hours-a-day').each(function (indexH, object) {
                                $(object).find('h3').html('0');
                                $('.time-entries').each(function (indexT) {
                                    if ($(this).index() - 1 == indexH) {
                                        $(object).find('h3').html(parseInt($(object).find('h3').html()) + parseInt($(this).find('text').find('h4').text()));
                                    }
                                });
                            });
                        }
                    })

                });

            });
        });

        $('.btn-add-entry').click(function () {
            var projectName = $(this).parent("td").parent("tr").find("td:first").text();
            $('#modalProjectTitle').text(projectName);
            var hiddenDate = $(this).parent("td").closest('table').find('th').eq($(this).parent("td").index()).find('text').html();
            $('#dateEntry').val(hiddenDate);
            $('#dateText').text('Date: ' + hiddenDate);
            var projectId = $(this).parent("td").parent("tr").find("td:first").find('input').val();
            $('#projectIdInput').val(projectId);

            $.ajax({
                url: baseAdress + '/Issues/' + projectId,
                dataType: 'json',
                success: function (result) {
                    $('.issue-selector').html('');
                    $.each(result.issues, function (index, object) {
                        $('.issue-selector').html($('.issue-selector').html() + '<option value="' + object.id + '">' + object.subject + '</option>')
                    });

                }
            })
            $.ajax({
                url: baseAdress + '/Activities/' + projectId,
                dataType: 'json',
                success: function (result) {
                    $('.activity-selector').html('');
                    $.each(result.activities, function (index, object) {
                        $('.activity-selector').html($('.activity-selector').html() + '<option value="' + object.id + '">' + object.name + '</option>')
                    });

                }
            });
        });
    })

</script>


<h2>My open projects</h2>

<hr />
<div class="container">
    <div class="row">
        <div>
            @Html.Label("Select the starting day of the week", null, new { @class = "control-label col-xs-3" })
            <div class="col-xs-3">
                <input type="date" id="date" />
            </div>
        </div>
    </div>
</div>
<hr />
<div class="container container-fluid datesTable" style="display: none">
    <table class="table table-responsive table-striped" id="table">
        <thead>
            <tr>
                <th scope="col">Project:</th>
                <th class="tableHeader"></th>
                <th class="tableHeader"></th>
                <th class="tableHeader"></th>
                <th class="tableHeader"></th>
                <th class="tableHeader"></th>

            </tr>
        </thead>

        <tbody>
            @foreach (var project in Model.Projects)
            {
                <tr class="table-row" id="@project.Id">
                    <td scope="row" style="width:25%">
                        @project.Name
                        <input type="hidden" value="@project.Id">

                    </td>
                    <td scope="row" class="time-entries">
                        <text></text>
                        <button type="button" class="btn btn-success btn-add-entry" data-toggle="modal" data-target="#timeEntryForm">
                            Add time entry
                        </button>
                    </td>
                    <td scope="row" class="time-entries">
                        <text></text>
                        <button type="button" class="btn btn-success btn-add-entry" data-toggle="modal" data-target="#timeEntryForm">
                            Add time entry
                        </button>
                    </td>
                    <td scope="row" class="time-entries">
                        <text></text>
                        <button type="button" class="btn btn-success btn-add-entry" data-toggle="modal" data-target="#timeEntryForm">
                            Add time entry
                        </button>
                    </td>
                    <td scope="row" class="time-entries">
                        <text></text>
                        <button type="button" class="btn btn-success btn-add-entry" data-toggle="modal" data-target="#timeEntryForm">
                            Add time entry
                        </button>
                    </td>
                    <td scope="row" class="time-entries">
                        <text></text>
                        <button type="button" class="btn btn-success btn-add-entry" data-toggle="modal" data-target="#timeEntryForm">
                            Add time entry
                        </button>
                    </td>
                </tr>
            }
            <tr>
                <td scope="row" style="width:25%">Total hours per day</td>
                <td class="hours-a-day" style="color:red"><h3>0</h3></td>
                <td class="hours-a-day" style="color:red"><h3>0</h3></td>
                <td class="hours-a-day" style="color:red"><h3>0</h3></td>
                <td class="hours-a-day" style="color:red"><h3>0</h3></td>
                <td class="hours-a-day" style="color:red"><h3>0</h3></td>
            </tr>
        </tbody>
    </table>
</div>

<!-- Modal -->
<div class="modal fade" id="timeEntryForm" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalProjectTitle"></h2>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group input-group">
                    <form action="/" method="post">
                        <input id="projectIdInput" type="hidden" name="projectId" value="" />
                        <input class="input-group" type="number" min="0" name="hours" placeholder="Enter hours" /><br />
                        <input class="input-group" type="text" name="description" placeholder="Enter description" /><br />
                        <h5>Select Issue</h5>
                        <select class="input-group issue-selector" name="issue">
                        </select><br />
                        <h5>Select Activity</h5>
                        <select class="input-group activity-selector" name="activity">
                        </select><br />
                        <input id="dateEntry" type="hidden" name="date" value="" />
                        <text class="input-group" id="dateText">Date: </text><br />
                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary">Save changes</button>
            </div>
        </div>
    </div>
</div>



